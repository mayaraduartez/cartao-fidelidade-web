<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu perfil</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="/style/style2.css">
</head>

<body class="fundo-amarelo">
  <div class="container mt-4">
    <h1 class="mb-4">Meu perfil</h1>

    <!-- FORMULÁRIO ÚNICO -->
    <form action="/atualizarPerfil" method="post" enctype="multipart/form-data">
      <div class="row">
        <!-- Coluna da foto + QR Code -->
        <div class="col-md-4 text-center mb-4">
          <!-- Foto do usuário -->
          <div class="text-left pl-3">
            <% if (user.foto) { %>
              <img id="previewFoto" src="/images/<%= user.foto %>" alt="Foto de perfil"
                   style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;"
                   class="mb-2">
            <% } else { %>
              <img id="previewFoto" src="/img/default.png" alt="Foto de perfil"
                   style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;"
                   class="mb-2">
            <% } %>
          </div>

          <!-- Upload da foto -->
          <input type="file" id="foto" name="foto" accept="image/*" class="form-control-file mb-3">

          <!-- QR Code -->
          <label>Meu QRcode:</label><br>
          <img src="/img/images.png" alt="QR Code" style="width: 100px;">
        </div>

        <!-- Coluna das informações -->
        <div class="col-md-8">
          <div class="form-group">
            <label>Nome:</label>
            <input type="text" name="nome" class="form-control" value="<%= user.nome || '' %>" required>
          </div>
          <div class="form-group">
            <label>CPF:</label>
            <input type="text" name="cpf" class="form-control" value="<%= user.cpf || '' %>">
          </div>
          <div class="form-group">
            <label>Telefone:</label>
            <input type="tel" name="telefone" class="form-control" value="<%= user.telefone || '' %>">
          </div>
          <div class="form-group">
            <label>Endereço:</label>
            <input type="text" name="endereco" class="form-control" value="<%= user.endereco || '' %>">
          </div>

          <!-- Botões -->
          <div class="mt-4 d-flex flex-wrap gap-2">
            <a href="/recuperarSenha" class="btn btn-warning mr-2 mb-2">Trocar senha</a>
            <button type="submit" class="btn btn-primary mr-2 mb-2">Atualizar Perfil</button>
            <button type="button" class="btn btn-success mb-2" onclick="renovarCartao()">Renovar cartão</button>
          </div>
        </div>
      </div>

      <!-- Histórico -->
      <h2 class="mt-5">Histórico de Refeições</h2>
      <table class="table table-bordered text-center historico-refeicoes">
        <thead class="thead-dark">
          <tr>
            <th>Data</th>
            <th>Refeição</th>
            <th>Valor (R$)</th>
          </tr>
        </thead>
        <tbody>
          <% if (user.historico && user.historico.length > 0) { %>
            <% user.historico.forEach(item => { %>
              <tr>
                <td><%= item.data %></td>
                <td><%= item.refeicao %></td>
                <td><%= item.valor %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="3">Nenhum histórico encontrado.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </form>
  </div>

  <!-- Scripts -->
  <script>
    // Preview da imagem antes de enviar
    document.getElementById("foto").addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("previewFoto").src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    function renovarCartao() {
      alert("Solicitação de renovação de cartão enviada!");
    }
  </script>
</body>
</html>
